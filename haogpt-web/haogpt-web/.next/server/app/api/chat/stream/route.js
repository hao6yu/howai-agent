"use strict";(()=>{var e={};e.id=480,e.ids=[480],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},8605:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>g,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>m,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{POST:()=>p});var s=r(9303),o=r(8716),a=r(670),i=r(8319),u=r(6943);let l=new i.ZP({apiKey:process.env.OPENAI_API_KEY});async function p(e){try{let{message:t,conversationId:r,deepResearch:n,attachments:s=[]}=await e.json();if(!t&&0===s.length||!r)return new Response("Message or attachments and conversation ID are required",{status:400});let o=(0,u.e)(),{data:{user:a},error:i}=await o.auth.getUser();if(i||!a)return new Response("Unauthorized",{status:401});let{data:p,error:c}=await o.from("conversations").select("id").eq("id",r).eq("user_id",a.id).single();if(c||!p)return new Response("Conversation not found or unauthorized",{status:404});let{data:d}=await o.from("messages").select("content, is_ai, created_at").eq("conversation_id",r).order("created_at",{ascending:!0}).limit(20),h=n?process.env.OPENAI_REASONING_MODEL||"o3":process.env.OPENAI_CHAT_MODEL||"gpt-4o-mini",m="You are HowAI, a helpful AI assistant designed for children. You should be friendly, educational, and age-appropriate in your responses. Keep your answers clear and engaging.";n&&(m+='\n\n\uD83E\uDDE0 DEEP RESEARCH MODE: You are using OpenAI\'s advanced o3 reasoning model. Provide deep, step-by-step logical analysis with comprehensive insights, multiple perspectives, and thorough explanations. Break down complex problems, consider pros and cons, and provide detailed reasoning for your conclusions. Focus on educational value and helping users understand not just the "what" but the "why" behind your answers.');let f=[{role:"system",content:m}];d&&d.forEach(e=>{f.push({role:e.is_ai?"assistant":"user",content:e.content})});let g=[];t&&g.push({type:"text",text:t}),s.forEach(e=>{"image"===e.type?g.push({type:"image_url",image_url:{url:`data:${e.mimeType};base64,${e.data}`,detail:n?"high":"auto"}}):"document"===e.type&&g.push({type:"text",text:`Document "${e.name}" content:

${e.content}`})}),f.push({role:"user",content:1===g.length&&"text"===g[0].type?g[0].text:g});let y="o3"===h||h===process.env.OPENAI_REASONING_MODEL,v={model:h,messages:f,stream:!0};y?v.max_completion_tokens=n?4e3:2e3:(v.max_tokens=n?2e3:1e3,v.temperature=n?.3:.7);let x=await l.chat.completions.create(v),_="",b=new TextEncoder,w=new ReadableStream({async start(e){try{for await(let t of x){let r=t.choices[0]?.delta?.content||"";r&&(_+=r,e.enqueue(b.encode(`data: ${JSON.stringify({content:r})}

`)))}_&&(await o.from("messages").insert({conversation_id:r,content:_,is_ai:!0}),await o.from("conversations").update({updated_at:new Date().toISOString()}).eq("id",r)),e.enqueue(b.encode("data: [DONE]\n\n")),e.close()}catch(t){console.error("Streaming error:",t),e.error(t)}}});return new Response(w,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}catch(e){return console.error("Chat streaming error:",e),new Response("Internal server error",{status:500})}}let c=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/chat/stream/route",pathname:"/api/chat/stream",filename:"route",bundlePath:"app/api/chat/stream/route"},resolvedPagePath:"/Users/haoyu/development/HaoGPT/haogpt-web/src/app/api/chat/stream/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:h,serverHooks:m}=c,f="/api/chat/stream/route";function g(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:h})}},9925:e=>{var t=Object.defineProperty,r=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,s=Object.prototype.hasOwnProperty,o={};function a(e){var t;let r=["path"in e&&e.path&&`Path=${e.path}`,"expires"in e&&(e.expires||0===e.expires)&&`Expires=${("number"==typeof e.expires?new Date(e.expires):e.expires).toUTCString()}`,"maxAge"in e&&"number"==typeof e.maxAge&&`Max-Age=${e.maxAge}`,"domain"in e&&e.domain&&`Domain=${e.domain}`,"secure"in e&&e.secure&&"Secure","httpOnly"in e&&e.httpOnly&&"HttpOnly","sameSite"in e&&e.sameSite&&`SameSite=${e.sameSite}`,"partitioned"in e&&e.partitioned&&"Partitioned","priority"in e&&e.priority&&`Priority=${e.priority}`].filter(Boolean),n=`${e.name}=${encodeURIComponent(null!=(t=e.value)?t:"")}`;return 0===r.length?n:`${n}; ${r.join("; ")}`}function i(e){let t=new Map;for(let r of e.split(/; */)){if(!r)continue;let e=r.indexOf("=");if(-1===e){t.set(r,"true");continue}let[n,s]=[r.slice(0,e),r.slice(e+1)];try{t.set(n,decodeURIComponent(null!=s?s:"true"))}catch{}}return t}function u(e){var t,r;if(!e)return;let[[n,s],...o]=i(e),{domain:a,expires:u,httponly:c,maxage:d,path:h,samesite:m,secure:f,partitioned:g,priority:y}=Object.fromEntries(o.map(([e,t])=>[e.toLowerCase(),t]));return function(e){let t={};for(let r in e)e[r]&&(t[r]=e[r]);return t}({name:n,value:decodeURIComponent(s),domain:a,...u&&{expires:new Date(u)},...c&&{httpOnly:!0},..."string"==typeof d&&{maxAge:Number(d)},path:h,...m&&{sameSite:l.includes(t=(t=m).toLowerCase())?t:void 0},...f&&{secure:!0},...y&&{priority:p.includes(r=(r=y).toLowerCase())?r:void 0},...g&&{partitioned:!0}})}((e,r)=>{for(var n in r)t(e,n,{get:r[n],enumerable:!0})})(o,{RequestCookies:()=>c,ResponseCookies:()=>d,parseCookie:()=>i,parseSetCookie:()=>u,stringifyCookie:()=>a}),e.exports=((e,o,a,i)=>{if(o&&"object"==typeof o||"function"==typeof o)for(let a of n(o))s.call(e,a)||void 0===a||t(e,a,{get:()=>o[a],enumerable:!(i=r(o,a))||i.enumerable});return e})(t({},"__esModule",{value:!0}),o);var l=["strict","lax","none"],p=["low","medium","high"],c=class{constructor(e){this._parsed=new Map,this._headers=e;let t=e.get("cookie");if(t)for(let[e,r]of i(t))this._parsed.set(e,{name:e,value:r})}[Symbol.iterator](){return this._parsed[Symbol.iterator]()}get size(){return this._parsed.size}get(...e){let t="string"==typeof e[0]?e[0]:e[0].name;return this._parsed.get(t)}getAll(...e){var t;let r=Array.from(this._parsed);if(!e.length)return r.map(([e,t])=>t);let n="string"==typeof e[0]?e[0]:null==(t=e[0])?void 0:t.name;return r.filter(([e])=>e===n).map(([e,t])=>t)}has(e){return this._parsed.has(e)}set(...e){let[t,r]=1===e.length?[e[0].name,e[0].value]:e,n=this._parsed;return n.set(t,{name:t,value:r}),this._headers.set("cookie",Array.from(n).map(([e,t])=>a(t)).join("; ")),this}delete(e){let t=this._parsed,r=Array.isArray(e)?e.map(e=>t.delete(e)):t.delete(e);return this._headers.set("cookie",Array.from(t).map(([e,t])=>a(t)).join("; ")),r}clear(){return this.delete(Array.from(this._parsed.keys())),this}[Symbol.for("edge-runtime.inspect.custom")](){return`RequestCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`}toString(){return[...this._parsed.values()].map(e=>`${e.name}=${encodeURIComponent(e.value)}`).join("; ")}},d=class{constructor(e){var t,r,n;this._parsed=new Map,this._headers=e;let s=null!=(n=null!=(r=null==(t=e.getSetCookie)?void 0:t.call(e))?r:e.get("set-cookie"))?n:[];for(let e of Array.isArray(s)?s:function(e){if(!e)return[];var t,r,n,s,o,a=[],i=0;function u(){for(;i<e.length&&/\s/.test(e.charAt(i));)i+=1;return i<e.length}for(;i<e.length;){for(t=i,o=!1;u();)if(","===(r=e.charAt(i))){for(n=i,i+=1,u(),s=i;i<e.length&&"="!==(r=e.charAt(i))&&";"!==r&&","!==r;)i+=1;i<e.length&&"="===e.charAt(i)?(o=!0,i=s,a.push(e.substring(t,n)),t=i):i=n+1}else i+=1;(!o||i>=e.length)&&a.push(e.substring(t,e.length))}return a}(s)){let t=u(e);t&&this._parsed.set(t.name,t)}}get(...e){let t="string"==typeof e[0]?e[0]:e[0].name;return this._parsed.get(t)}getAll(...e){var t;let r=Array.from(this._parsed.values());if(!e.length)return r;let n="string"==typeof e[0]?e[0]:null==(t=e[0])?void 0:t.name;return r.filter(e=>e.name===n)}has(e){return this._parsed.has(e)}set(...e){let[t,r,n]=1===e.length?[e[0].name,e[0].value,e[0]]:e,s=this._parsed;return s.set(t,function(e={name:"",value:""}){return"number"==typeof e.expires&&(e.expires=new Date(e.expires)),e.maxAge&&(e.expires=new Date(Date.now()+1e3*e.maxAge)),(null===e.path||void 0===e.path)&&(e.path="/"),e}({name:t,value:r,...n})),function(e,t){for(let[,r]of(t.delete("set-cookie"),e)){let e=a(r);t.append("set-cookie",e)}}(s,this._headers),this}delete(...e){let[t,r,n]="string"==typeof e[0]?[e[0]]:[e[0].name,e[0].path,e[0].domain];return this.set({name:t,path:r,domain:n,value:"",expires:new Date(0)})}[Symbol.for("edge-runtime.inspect.custom")](){return`ResponseCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`}toString(){return[...this._parsed.values()].map(a).join("; ")}}},9303:(e,t,r)=>{e.exports=r(517)},8238:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"ReflectAdapter",{enumerable:!0,get:function(){return r}});class r{static get(e,t,r){let n=Reflect.get(e,t,r);return"function"==typeof n?n.bind(e):n}static set(e,t,r,n){return Reflect.set(e,t,r,n)}static has(e,t){return Reflect.has(e,t)}static deleteProperty(e,t){return Reflect.deleteProperty(e,t)}}},2044:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{RequestCookies:function(){return n.RequestCookies},ResponseCookies:function(){return n.ResponseCookies},stringifyCookie:function(){return n.stringifyCookie}});let n=r(9925)},6943:(e,t,r)=>{r.d(t,{e:()=>o});var n=r(6718),s=r(1615);function o(){let e=(0,s.cookies)();return(0,n.createServerClient)("https://yjxoreszkpdealtzyvyu.supabase.co","sb_publishable_NvluG8lAmJXglB0qQRwGRg_bPzYdvDP",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:n})=>e.set(t,r,n))}catch{}}}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,305,319],()=>r(8605));module.exports=n})();